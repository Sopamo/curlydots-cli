name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  publish-npm:
    name: Publish npm package (debug)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show runtime versions
        run: |
          node --version
          npm --version

      - name: Show npx npm@latest version
        run: npx --yes npm@latest --version

      - name: Remove npm token configuration
        run: |
          rm -f "$HOME/.npmrc"
          npm config delete "//registry.npmjs.org/:_authToken" --location=user || true
          npm config delete "//registry.npmjs.org/:_authToken" --location=project || true
          npm config delete always-auth --location=user || true
          npm config delete always-auth --location=project || true

      - name: Stamp package version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          npm pkg set version="${VERSION}"

      - name: Inspect OIDC claims for npm audience
        run: |
          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]; then
            echo "OIDC request environment is missing"
            exit 1
          fi

          RESPONSE="$(curl -fsSL -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=npm:registry.npmjs.org")"
          TOKEN="$(node -e "const r=JSON.parse(process.argv[1]);process.stdout.write(r.value)" "${RESPONSE}")"
          node -e '
            const token = process.argv[1];
            const payload = token.split(".")[1];
            const normalized = payload.replace(/-/g, "+").replace(/_/g, "/");
            const padded = normalized + "=".repeat((4 - (normalized.length % 4 || 4)) % 4);
            const claims = JSON.parse(Buffer.from(padded, "base64").toString("utf8"));
            const selected = {
              iss: claims.iss,
              aud: claims.aud,
              sub: claims.sub,
              repository: claims.repository,
              repository_owner: claims.repository_owner,
              workflow_ref: claims.workflow_ref,
              job_workflow_ref: claims.job_workflow_ref,
              ref: claims.ref
            };
            console.log(JSON.stringify(selected, null, 2));
          ' "${TOKEN}"

      - name: Check npm OIDC exchange for package
        run: |
          RESPONSE="$(curl -fsSL -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=npm:registry.npmjs.org")"
          TOKEN="$(node -e "const r=JSON.parse(process.argv[1]);process.stdout.write(r.value)" "${RESPONSE}")"
          STATUS="$(curl -sS -o npm-oidc-exchange.json -w "%{http_code}" -X POST -H "Authorization: Bearer ${TOKEN}" "https://registry.npmjs.org/-/npm/v1/oidc/token/exchange/package/%40curlydots%2Fcli")"
          echo "npm OIDC exchange status: ${STATUS}"
          cat npm-oidc-exchange.json
          if [ "${STATUS}" -ne 201 ]; then
            echo "npm OIDC exchange failed"
            exit 1
          fi

      - name: Publish package with trusted publishing
        run: npx --yes npm@latest publish --provenance --access public --registry https://registry.npmjs.org/
